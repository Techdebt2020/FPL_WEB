// functions/index.js (for Netlify Functions)
const fetch = require('node-fetch'); // For making HTTP requests from the function
const cors = require('cors')(); // Enable CORS for the function

/**
 * Netlify Function to proxy requests to the FPL API.
 * This bypasses CORS restrictions encountered in client-side applications.
 *
 * It handles two main FPL API endpoints:
 * 1. /bootstrap-static/ (for current gameweek info)
 * 2. /leagues-classic/{league_id}/standings/ (for league standings)
 *
 * Requests to this function should include 'endpoint' as a query parameter
 * and 'leagueId' if the 'league-standings' endpoint is requested.
 *
 * Netlify Functions are accessed via /.netlify/functions/YOUR_FUNCTION_NAME
 * So, this function will be available at /.netlify/functions/fplProxy
 *
 * @param {object} event - The event object from Netlify (contains queryStringParameters)
 * @param {object} context - The context object from Netlify
 * @returns {object} - The response object
 */
exports.handler = async (event, context) => {
    // Netlify Functions automatically handle CORS if you use the `cors` middleware
    // but we'll manually apply it here for consistency with the Firebase example
    // and to ensure the response headers are correctly set.
    return new Promise((resolve, reject) => {
        cors(event, {
            send: (body) => resolve({
                statusCode: 200,
                headers: {
                    "Content-Type": "application/json",
                    "Access-Control-Allow-Origin": "*", // Allow all origins for simplicity, tighten in production
                    "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
                    "Access-Control-Allow-Headers": "Content-Type"
                },
                body: JSON.stringify(body)
            }),
            status: (statusCode) => ({
                send: (body) => resolve({
                    statusCode: statusCode,
                    headers: {
                        "Content-Type": "application/json",
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
                        "Access-Control-Allow-Headers": "Content-Type"
                    },
                    body: JSON.stringify(body)
                })
            })
        }, async () => {
            const fplBaseUrl = 'https://fantasy.premierleague.com/api/';
            const endpoint = event.queryStringParameters.endpoint;
            const leagueId = event.queryStringParameters.leagueId;

            let fplApiUrl = '';

            // Determine which FPL API endpoint to hit based on the 'endpoint' query parameter
            if (endpoint === 'bootstrap-static') {
                fplApiUrl = `${fplBaseUrl}bootstrap-static/`;
            } else if (endpoint === 'league-standings') {
                if (!leagueId) {
                    // If leagueId is missing for league-standings, return an error
                    resolve({
                        statusCode: 400,
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ error: 'Bad Request: leagueId is required for league-standings endpoint.' })
                    });
                    return;
                }
                fplApiUrl = `${fplBaseUrl}leagues-classic/${leagueId}/standings/`;
            } else {
                // If an invalid or missing endpoint is provided, return an error
                resolve({
                    statusCode: 400,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ error: 'Bad Request: Invalid or missing "endpoint" parameter.' })
                });
                return;
            }

            try {
                // Make the request to the actual FPL API
                const fplResponse = await fetch(fplApiUrl);

                // Check if the FPL API response was successful
                if (!fplResponse.ok) {
                    const errorText = await fplResponse.text();
                    console.error(`FPL API returned an error: ${fplResponse.status} - ${errorText}`);
                    resolve({
                        statusCode: fplResponse.status,
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ error: `Error from FPL API: ${fplResponse.statusText}` })
                    });
                    return;
                }

                // Parse the JSON response from FPL API
                const data = await fplResponse.json();

                // Send the data back to the client
                resolve({
                    statusCode: 200,
                    headers: {
                        "Content-Type": "application/json",
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
                        "Access-Control-Allow-Headers": "Content-Type"
                    },
                    body: JSON.stringify(data)
                });

            } catch (error) {
                // Log and send any errors that occur during the fetch operation
                console.error('Error fetching data from FPL API:', error);
                resolve({
                    statusCode: 500,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ error: `Internal Server Error: ${error.message}` })
                });
            }
        });
    });
};
