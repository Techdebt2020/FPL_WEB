<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2487.3">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #6d7378; -webkit-text-stroke: #6d7378}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #71c083; -webkit-text-stroke: #71c083}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #cacaca; -webkit-text-stroke: #cacaca; min-height: 16.0px}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #cacaca; -webkit-text-stroke: #cacaca}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #d4d4d4; -webkit-text-stroke: #d4d4d4}
    span.s1 {font-kerning: none; background-color: #171818}
    span.s2 {font-kerning: none; color: #b76ff7; background-color: #171818; -webkit-text-stroke: 0px #b76ff7}
    span.s3 {font-kerning: none; color: #cacaca; background-color: #171818; -webkit-text-stroke: 0px #cacaca}
    span.s4 {font-kerning: none; color: #d4d4d4; background-color: #171818; -webkit-text-stroke: 0px #d4d4d4}
    span.s5 {font-kerning: none; color: #71c083; background-color: #171818; -webkit-text-stroke: 0px #71c083}
    span.s6 {font-kerning: none}
    span.s7 {font-kerning: none; color: #f67c30; background-color: #171818; -webkit-text-stroke: 0px #f67c30}
  </style>
</head>
<body>
<p class="p1"><span class="s1">// functions/index.js</span></p>
<p class="p2"><span class="s2">const</span><span class="s3"> functions </span><span class="s4">=</span><span class="s3"> require</span><span class="s4">(</span><span class="s1">'firebase-functions'</span><span class="s4">);</span></p>
<p class="p1"><span class="s2">const</span><span class="s3"> fetch </span><span class="s4">=</span><span class="s3"> require</span><span class="s4">(</span><span class="s5">'node-fetch'</span><span class="s4">);</span><span class="s3"> </span><span class="s1">// For making HTTP requests from the function</span></p>
<p class="p1"><span class="s2">const</span><span class="s3"> cors </span><span class="s4">=</span><span class="s3"> require</span><span class="s4">(</span><span class="s5">'cors'</span><span class="s4">)({</span><span class="s3"> origin</span><span class="s4">:</span><span class="s3"> </span><span class="s2">true</span><span class="s3"> </span><span class="s4">});</span><span class="s3"> </span><span class="s1">// Enable CORS for the function</span></p>
<p class="p3"><span class="s6"></span><br></p>
<p class="p1"><span class="s1">/**</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>* Firebase Function to proxy requests to the FPL API.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>* This bypasses CORS restrictions encountered in client-side applications.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>*</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>* It handles two main FPL API endpoints:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>* 1. /bootstrap-static/ (for current gameweek info)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>* 2. /leagues-classic/{league_id}/standings/ (for league standings)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>*</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>* Requests to this function should include 'endpoint' as a query parameter</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>* and 'leagueId' if the 'league-standings' endpoint is requested.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>*</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>* Example usage from client-side:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>* - /api/fpl-proxy?endpoint=bootstrap-static</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>* - /api/fpl-proxy?endpoint=league-standings&amp;leagueId=123456</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p4"><span class="s1">exports</span><span class="s4">.</span><span class="s1">fplProxy </span><span class="s4">=</span><span class="s1"> functions</span><span class="s4">.</span><span class="s1">https</span><span class="s4">.</span><span class="s1">onRequest</span><span class="s4">((</span><span class="s1">request</span><span class="s4">,</span><span class="s1"> response</span><span class="s4">)</span><span class="s1"> </span><span class="s4">=&gt;</span><span class="s1"> </span><span class="s4">{</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s1">// Enable CORS for the function</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>cors</span><span class="s4">(</span><span class="s1">request</span><span class="s4">,</span><span class="s1"> response</span><span class="s4">,</span><span class="s1"> </span><span class="s2">async</span><span class="s1"> </span><span class="s4">()</span><span class="s1"> </span><span class="s4">=&gt;</span><span class="s1"> </span><span class="s4">{</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">const</span><span class="s3"> fplBaseUrl </span><span class="s4">=</span><span class="s3"> </span><span class="s1">'https://fantasy.premierleague.com/api/'</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">const</span><span class="s1"> endpoint </span><span class="s4">=</span><span class="s1"> request</span><span class="s4">.</span><span class="s1">query</span><span class="s4">.</span><span class="s1">endpoint</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">const</span><span class="s1"> leagueId </span><span class="s4">=</span><span class="s1"> request</span><span class="s4">.</span><span class="s1">query</span><span class="s4">.</span><span class="s1">leagueId</span><span class="s4">;</span></p>
<p class="p3"><span class="s6"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">let</span><span class="s1"> fplApiUrl </span><span class="s4">=</span><span class="s1"> </span><span class="s5">''</span><span class="s4">;</span></p>
<p class="p3"><span class="s6"></span><br></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">// Determine which FPL API endpoint to hit based on the 'endpoint' query parameter</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">if</span><span class="s1"> </span><span class="s4">(</span><span class="s1">endpoint </span><span class="s4">===</span><span class="s1"> </span><span class="s5">'bootstrap-static'</span><span class="s4">)</span><span class="s1"> </span><span class="s4">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span>fplApiUrl </span><span class="s4">=</span><span class="s1"> </span><span class="s5">`</span><span class="s4">${</span><span class="s1">fplBaseUrl</span><span class="s4">}</span><span class="s5">bootstrap-static/`</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">}</span><span class="s1"> </span><span class="s2">else</span><span class="s1"> </span><span class="s2">if</span><span class="s1"> </span><span class="s4">(</span><span class="s1">endpoint </span><span class="s4">===</span><span class="s1"> </span><span class="s5">'league-standings'</span><span class="s4">)</span><span class="s1"> </span><span class="s4">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s2">if</span><span class="s1"> </span><span class="s4">(!</span><span class="s1">leagueId</span><span class="s4">)</span><span class="s1"> </span><span class="s4">{</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">                </span></span><span class="s1">// If leagueId is missing for league-standings, return an error</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">                </span>response</span><span class="s4">.</span><span class="s3">status</span><span class="s4">(</span><span class="s7">400</span><span class="s4">).</span><span class="s3">send</span><span class="s4">(</span><span class="s1">'Bad Request: leagueId is required for league-standings endpoint.'</span><span class="s4">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s2">return</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span>fplApiUrl </span><span class="s4">=</span><span class="s1"> </span><span class="s5">`</span><span class="s4">${</span><span class="s1">fplBaseUrl</span><span class="s4">}</span><span class="s5">leagues-classic/</span><span class="s4">${</span><span class="s1">leagueId</span><span class="s4">}</span><span class="s5">/standings/`</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">}</span><span class="s1"> </span><span class="s2">else</span><span class="s1"> </span><span class="s4">{</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">// If an invalid or missing endpoint is provided, return an error</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">            </span>response</span><span class="s4">.</span><span class="s3">status</span><span class="s4">(</span><span class="s7">400</span><span class="s4">).</span><span class="s3">send</span><span class="s4">(</span><span class="s1">'Bad Request: Invalid or missing "endpoint" parameter.'</span><span class="s4">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s2">return</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">}</span></p>
<p class="p3"><span class="s6"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">try</span><span class="s1"> </span><span class="s4">{</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">// Make the request to the actual FPL API</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s2">const</span><span class="s1"> fplResponse </span><span class="s4">=</span><span class="s1"> </span><span class="s2">await</span><span class="s1"> fetch</span><span class="s4">(</span><span class="s1">fplApiUrl</span><span class="s4">);</span></p>
<p class="p3"><span class="s6"></span><br></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">// Check if the FPL API response was successful</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s2">if</span><span class="s1"> </span><span class="s4">(!</span><span class="s1">fplResponse</span><span class="s4">.</span><span class="s1">ok</span><span class="s4">)</span><span class="s1"> </span><span class="s4">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s2">const</span><span class="s1"> errorText </span><span class="s4">=</span><span class="s1"> </span><span class="s2">await</span><span class="s1"> fplResponse</span><span class="s4">.</span><span class="s1">text</span><span class="s4">();</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">                </span>console</span><span class="s4">.</span><span class="s1">error</span><span class="s4">(</span><span class="s5">`FPL API returned an error: </span><span class="s4">${</span><span class="s1">fplResponse</span><span class="s4">.</span><span class="s1">status</span><span class="s4">}</span><span class="s5"> - </span><span class="s4">${</span><span class="s1">errorText</span><span class="s4">}</span><span class="s5">`</span><span class="s4">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">                </span>response</span><span class="s4">.</span><span class="s1">status</span><span class="s4">(</span><span class="s1">fplResponse</span><span class="s4">.</span><span class="s1">status</span><span class="s4">).</span><span class="s1">send</span><span class="s4">(</span><span class="s5">`Error from FPL API: </span><span class="s4">${</span><span class="s1">fplResponse</span><span class="s4">.</span><span class="s1">statusText</span><span class="s4">}</span><span class="s5">`</span><span class="s4">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s2">return</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">}</span></p>
<p class="p3"><span class="s6"></span><br></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">// Parse the JSON response from FPL API</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s2">const</span><span class="s1"> data </span><span class="s4">=</span><span class="s1"> </span><span class="s2">await</span><span class="s1"> fplResponse</span><span class="s4">.</span><span class="s1">json</span><span class="s4">();</span></p>
<p class="p3"><span class="s6"></span><br></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">// Send the data back to the client</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span>response</span><span class="s4">.</span><span class="s1">status</span><span class="s4">(</span><span class="s7">200</span><span class="s4">).</span><span class="s1">json</span><span class="s4">(</span><span class="s1">data</span><span class="s4">);</span></p>
<p class="p3"><span class="s6"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">}</span><span class="s1"> </span><span class="s2">catch</span><span class="s1"> </span><span class="s4">(</span><span class="s1">error</span><span class="s4">)</span><span class="s1"> </span><span class="s4">{</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">// Log and send any errors that occur during the fetch operation</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">            </span>console</span><span class="s4">.</span><span class="s3">error</span><span class="s4">(</span><span class="s1">'Error fetching data from FPL API:'</span><span class="s4">,</span><span class="s3"> error</span><span class="s4">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span>response</span><span class="s4">.</span><span class="s1">status</span><span class="s4">(</span><span class="s7">500</span><span class="s4">).</span><span class="s1">send</span><span class="s4">(</span><span class="s5">`Internal Server Error: </span><span class="s4">${</span><span class="s1">error</span><span class="s4">.</span><span class="s1">message</span><span class="s4">}</span><span class="s5">`</span><span class="s4">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s4">});</span></p>
<p class="p5"><span class="s1">});</span></p>
<p class="p3"><span class="s6"></span><br></p>
</body>
</html>
